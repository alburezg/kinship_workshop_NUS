---
title: "Kinship Dynamics: Concept, Modelling, and Applications"
subtitle: "National University of Singapore, Singapore, February 5, 2025"
author: "Instructors: Diego Alburez-Gutierrez & Sha Jiang"
date: "Updated: `r Sys.Date()`"
output:
  html_document:
    # toc_depth: 2
    toc_float: true
    # number_sections: true
    theme: readable
    highlight: pygments
    # code_folding: hide
bibliography: kinship.bib
---

```{r 1 setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      message = FALSE, 
                      warning = FALSE, 
                      fig.align='center')

# Prevent scientific notation (useful for the rate calculation)
options(scipen=999999)
```


# {.tabset}
## Introduction 

### Preparation

Please make sure to complete the following preparatory steps before the training workshop:

1. If you haven't already, install R and RStudio. This is a useful tutorial: https://rstudio-education.github.io/hopr/starting.html 
1. Install the following packages in R:

```{r = installs, eval=FALSE}
install.packages("tidyverse")
install.packages("devtools")
devtools::install_github("IvanWilli/DemoKin")
```

1. Download the workshop's GitHub repository to your computer: https://github.com/alburezg/kinship_workshop_NUS. The easiest way is by clicking on `< > Code` and then `Download ZIP`:


### Course description: 

Kinship is a fundamental property of human populations and a key form of social structure.
Demographers have long been interested in the interplay between demographic change and family configuration.
This has led to the development of sophisticated methodological and conceptual approaches for the study of kinship, some of which are reviewed in this course. 


## Part 1: Kinship models

#### 1. Installation


#### Load other packages that will be useful:

```{r 3, warning=F, message=FALSE}
library(dplyr)
library(tidyr)
library(ggplot2)
```

### Input demographic data

We will use data for Singapore from the 2024 Revision of the World Population Prospects. 
We pre-processed the data for this workshop for your convenience:

```{r, warning=FALSE, message=FALSE}
#Load data
rates_female <- read.csv("data/col_female.csv", stringsAsFactors = F) #female rates
pop_female <- read.csv("data/col_popfemale.csv", stringsAsFactors = F) #female population (N)
# For men
rates_male <- read.csv("data/col_male.csv", stringsAsFactors = F) # male rates
pop_male <- read.csv("data/col_popmale.csv", stringsAsFactors = F) # male population (N)
```

Let's see what data we will be using. The first object is `rates_female`, a long-format data frame with year- and age-specific fertility rates ('fx') and survival probabilities from a life table ('px'). 

```{r, warning=FALSE, message=FALSE}
head(rates_female)
```

Let us visualise some of our demographic data. 
We start with the probability of dying between ages $x$ and $x+1$,$q_x$ in a life table:

```{r}
rates_female %>%
    filter(year %in% seq(1950, 2020, 30)) %>% 
    mutate(qx = 1-px) %>%
    ggplot() +
    geom_line(aes(x = age, y = qx, col = as.character(year))) +
    scale_y_log10() +
    labs(y = "Probability of dying, qx", col = NULL) +
    theme_bw() +
    theme(legend.position = "bottom")
```

Next, we have age-specific fertility rates for multiple years:

```{r}
rates_female %>%
  filter(year %in% seq(1950, 2020, 30)) %>% 
  ggplot() + 
  geom_line(aes(x = age, y = fx, col = as.character(year))) +
  labs(y = "Age-specific fertility rate, fx", col = NULL) +
  theme_bw() +
  theme(legend.position = "bottom")
```

Finally, we have the population counts:

```{r}
pop_female %>%
  mutate(age = 0:100) %>% 
  pivot_longer(-age, names_to = "year", values_to = "pop") %>% 
  mutate(year = gsub("X", "", year)) %>% 
  filter(year %in% seq(1950, 2020, 30)) %>% 
  ggplot() + 
  geom_line(aes(x = age, y = pop, col = as.character(year))) +
  labs(y = "Population alive in thousands", col = NULL) +
  theme_bw() +
  theme(legend.position = "bottom")
```

### 1. The DemoKin package

Load the package into R. If you haven't done so already, install DemoKin from GitHub:

```{r 2, warning=F, message=FALSE}
# Install the development version from GitHub

#install.packages("devtools")
#devtools::install_github("IvanWilli/DemoKin")

library(DemoKin)
```

#### 1.1. The function `kin()`

`DemoKin` can be used to compute the number and age distribution of Focal's relatives under a range of assumptions, including living and deceased kin. The function `DemoKin::kin()` currently does most of the heavy lifting in terms of implementing matrix kinship models.

This is what it looks like in action, in this case assuming time-invariant demographic rates:

## Part 2: Projections of kinship



## References

